<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>체스 게임</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 70px);
      grid-template-rows: repeat(8, 70px);
      gap: 0;
      border: 2px solid #333;
    }
    .square {
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }
    .white {
      background-color: #f0d9b5;
    }
    .black {
      background-color: #b58863;
    }
    .highlight {
      outline: 3px solid yellow;
    }
    .dot {
      width: 15px;
      height: 15px;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 50%;
      position: absolute;
    }
    #promotionModal {
      display: none;
      position: fixed;
      top: 30%;
      left: 40%;
      background: white;
      padding: 10px;
      border: 1px solid black;
    }
    .promotion-option {
      font-size: 30px;
      cursor: pointer;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h2>체스 게임</h2>
  <div id="board"></div>
  <div id="promotionModal"></div>

  <script>
    const boardElement = document.getElementById("board");
    const promotionModal = document.getElementById("promotionModal");

    const initialBoard = [
      ['r','n','b','q','k','b','n','r'],
      ['p','p','p','p','p','p','p','p'],
      ['','','','','','','',''],
      ['','','','','','','',''],
      ['','','','','','','',''],
      ['','','','','','','',''],
      ['P','P','P','P','P','P','P','P'],
      ['R','N','B','Q','K','B','N','R']
    ];

    let boardState = JSON.parse(JSON.stringify(initialBoard));
    let selected = null;
    let currentTurn = 'white';
    let legalMoves = [];
    let castlingRights = {
      white: { kingside: true, queenside: true },
      black: { kingside: true, queenside: true }
    };
    let enPassantTarget = null;

    const pieceUnicode = {
      'K': '♔', 'Q': '♕', 'R': '♖', 'B': '♗', 'N': '♘', 'P': '♙',
      'k': '♚', 'q': '♛', 'r': '♜', 'b': '♝', 'n': '♞', 'p': '♟︎'
    };

    function createPieceElement(piece) {
      return pieceUnicode[piece] || '';
    }

    function drawBoard() {
      boardElement.innerHTML = '';
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const square = document.createElement("div");
          square.className = `square ${(r + c) % 2 === 0 ? 'white' : 'black'}`;
          square.dataset.row = r;
          square.dataset.col = c;
          square.addEventListener('click', () => onSquareClick(r, c));
          const piece = boardState[r][c];
          square.textContent = createPieceElement(piece);
          boardElement.appendChild(square);
        }
      }
      highlightLegalMoves();
    }

    function onSquareClick(row, col) {
      const piece = boardState[row][col];
      if (selected) {
        if (legalMoves.some(m => m[0] === row && m[1] === col)) {
          makeMove(selected[0], selected[1], row, col);
          selected = null;
          legalMoves = [];
        } else {
          selected = null;
          legalMoves = [];
        }
      } else if (piece && isTurn(piece)) {
        selected = [row, col];
        legalMoves = getLegalMoves(row, col, boardState);
      }
      drawBoard();
    }

    function isTurn(piece) {
      return (currentTurn === 'white' && piece === piece.toUpperCase()) ||
             (currentTurn === 'black' && piece === piece.toLowerCase());
    }

    function isUpper(p) {
      return p === p.toUpperCase();
    }

    function isLower(p) {
      return p === p.toLowerCase();
    }

    function makeMove(sr, sc, dr, dc) {
      const movingPiece = boardState[sr][sc];
      const target = boardState[dr][dc];

      // 캐슬링 처리
      if (movingPiece.toLowerCase() === 'k' && Math.abs(dc - sc) === 2) {
        if (dc === 6) { // kingside
          boardState[dr][5] = boardState[dr][7];
          boardState[dr][7] = '';
        } else if (dc === 2) { // queenside
          boardState[dr][3] = boardState[dr][0];
          boardState[dr][0] = '';
        }
      }

      // 앙파상 처리
      if (movingPiece.toLowerCase() === 'p' && dc !== sc && boardState[dr][dc] === '') {
        boardState[sr][dc] = '';
      }

      boardState[dr][dc] = movingPiece;
      boardState[sr][sc] = '';

      // 캐슬링 권리 제거
      if (movingPiece === 'K') castlingRights.white = { kingside: false, queenside: false };
      if (movingPiece === 'k') castlingRights.black = { kingside: false, queenside: false };
      if (movingPiece === 'R') {
        if (sr === 7 && sc === 0) castlingRights.white.queenside = false;
        if (sr === 7 && sc === 7) castlingRights.white.kingside = false;
      }
      if (movingPiece === 'r') {
        if (sr === 0 && sc === 0) castlingRights.black.queenside = false;
        if (sr === 0 && sc === 7) castlingRights.black.kingside = false;
      }

      // 앙파상 타겟 설정
      if (movingPiece.toLowerCase() === 'p' && Math.abs(dr - sr) === 2) {
        enPassantTarget = [(sr + dr) / 2, dc];
      } else {
        enPassantTarget = null;
      }

      // 프로모션
      if ((movingPiece === 'P' && dr === 0) || (movingPiece === 'p' && dr === 7)) {
        showPromotion(dr, dc, movingPiece);
        return;
      }

      currentTurn = currentTurn === 'white' ? 'black' : 'white';
    }

    function showPromotion(row, col, pawn) {
      promotionModal.innerHTML = '';
      promotionModal.style.display = 'block';
      const options = ['q', 'r', 'b', 'n'];
      options.forEach(opt => {
        const div = document.createElement('div');
        div.className = 'promotion-option';
        div.textContent = createPieceElement(pawn === 'P' ? opt.toUpperCase() : opt);
        div.onclick = () => {
          boardState[row][col] = pawn === 'P' ? opt.toUpperCase() : opt;
          promotionModal.style.display = 'none';
          currentTurn = currentTurn === 'white' ? 'black' : 'white';
          drawBoard();
        };
        promotionModal.appendChild(div);
      });
    }

    function getLegalMoves(row, col, board) {
      const moves = [];
      const piece = board[row][col];
      const isWhite = isUpper(piece);
      const dir = isWhite ? -1 : 1;

      // 일반 기물 이동은 생략 (기존에 구현된 것으로 가정)
      // 여기에 폰 이동, 캐슬링, 앙파상 관련 규칙만 예시로 포함

      if (piece.toLowerCase() === 'p') {
        if (board[row + dir] && board[row + dir][col] === '') {
          moves.push([row + dir, col]);
          if ((isWhite && row === 6) || (!isWhite && row === 1)) {
            if (board[row + dir * 2][col] === '') {
              moves.push([row + dir * 2, col]);
            }
          }
        }
        [-1, 1].forEach(d => {
          const target = board[row + dir]?.[col + d];
          if (target && isUpper(target) !== isWhite) {
            moves.push([row + dir, col + d]);
          }
        });
        // 앙파상
        if (enPassantTarget && enPassantTarget[0] === row + dir && Math.abs(enPassantTarget[1] - col) === 1) {
          moves.push([...enPassantTarget]);
        }
      }

      // 캐슬링
      if (piece.toLowerCase() === 'k' && !isKingInCheck(board, currentTurn)) {
        const homeRow = isWhite ? 7 : 0;
        if (castlingRights[currentTurn].kingside &&
            board[homeRow][5] === '' &&
            board[homeRow][6] === '') {
          moves.push([homeRow, 6]);
        }
        if (castlingRights[currentTurn].queenside &&
            board[homeRow][1] === '' &&
            board[homeRow][2] === '' &&
            board[homeRow][3] === '') {
          moves.push([homeRow, 2]);
        }
      }

      return moves;
    }

    function highlightLegalMoves() {
      const squares = boardElement.querySelectorAll('.square');
      squares.forEach(sq => sq.classList.remove('highlight'));
      legalMoves.forEach(([r, c]) => {
        const index = r * 8 + c;
        squares[index].classList.add('highlight');
      });
    }

    function isKingInCheck(board, side) {
      // 간단화된 체크 판별 (자세한 구현은 생략)
      return false;
    }

    drawBoard();
  </script>
</body>
</html>
